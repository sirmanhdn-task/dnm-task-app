<!--
VERSION: V6.2
DATE: 2025-01-15
CHANGES:
- Thêm buildSlots() với độ phân giải 10 phút, giới hạn timeline 14 ngày
- Shading Available/Unavailable dựa trên slots (ưu tiên non-parallel background)
- Thêm Day Header hiển thị ngày chạy theo timeline
- Giữ nguyên giao diện: Timeline + List + Background + Settings, zoom, JumpToNow
-->

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>DNM Task Scheduler V6.2</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container">

    <h1>DNM Task Scheduler V6.2</h1>

    <!-- AUTH BAR -->
    <div id="authBar" class="auth-bar">
        <div id="userInfo" class="user-info hidden">
            <span id="userName"></span>
            <button id="logoutBtn" class="logout-btn">Đăng xuất</button>
        </div>
        <div id="loginArea">
            <button id="loginBtn" class="login-btn">Đăng nhập Google</button>
        </div>
    </div>

    <div id="notLoggedInMessage" class="not-logged-in-msg">
        Vui lòng đăng nhập bằng Google để sử dụng ứng dụng.
    </div>

    <div id="appContent" class="app-content hidden">

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn tab-btn-active" id="tab-timeline-btn" onclick="switchTab('timeline')">Timeline</button>
            <button class="tab-btn" id="tab-list-btn" onclick="switchTab('list')">List</button>
            <button class="tab-btn" id="tab-background-btn" onclick="switchTab('background')">Background</button>
            <button class="tab-btn" id="tab-settings-btn" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- TIMELINE TAB -->
        <div id="tab-timeline">
            <!-- CARD: TIMELINE -->
            <div class="card">
                <h2>Timeline</h2>

                <div class="timeline-topbar">
                    <button id="jumpNowBtn" class="jump-now-btn" onclick="jumpToNow()">Hiện tại</button>
                    <button id="debugSlotsBtn" class="jump-now-btn" style="background:#555;" onclick="debugSlots()">Debug Slots</button>
                    <div class="zoom-controls">
                        <button onclick="zoomOut()">−</button>
                        <span id="zoomDisplay">100%</span>
                        <button onclick="zoomIn()">+</button>
                    </div>
                </div>

                <div class="timeline-scroll">
                    <div id="timelineDayHeader" class="timeline-day-header"></div>
                    <div id="timelineContainer" class="timeline-container">
                        <div id="timelineDays" class="timeline-days"></div>

                        <!-- Lớp shading availability -->
                        <div id="timelineAvailability" class="timeline-availability"></div>

                        <div class="timeline-header" id="timelineHeader"></div>

                        <div class="timeline-lane timeline-lane-normal" id="lane-normal"></div>
                        <div class="timeline-lane timeline-lane-background" id="lane-background"></div>
                        <div class="timeline-lane timeline-lane-pending" id="lane-pending"></div>

                        <div id="timelineCurrentLine"></div>
                    </div>
                </div>

                <!-- LEGEND -->
                <div class="timeline-legend">
                    <span><span class="legend-box legend-normal"></span> Normal tasks</span>
                    <span><span class="legend-box legend-background"></span> Background tasks</span>
                    <span><span class="legend-box legend-pending"></span> Pending tasks</span>
                    <span><span class="legend-box legend-available"></span> Available slot</span>
                    <span><span class="legend-box legend-unavailable"></span> Unavailable slot</span>
                </div>
            </div>
        </div>

        <!-- LIST TAB -->
        <div id="tab-list" class="hidden">

            <div class="form-section">
                <h2>Thêm công việc</h2>

                <div class="form-row">
                    <label>Tên công việc</label>
                    <input type="text" id="taskNameInput" placeholder="Tên" />
                </div>

                <div class="form-row">
                    <label>Mô tả (optional)</label>
                    <textarea id="taskDescInput" rows="2"></textarea>
                </div>

                <div class="form-row">
                    <label>Thời gian cần (phút)</label>
                    <input type="number" id="taskEstimatedInput" min="1" value="30" />
                </div>

                <div class="form-row">
                    <label>Deadline</label>
                    <input type="datetime-local" id="taskDeadlineInput" />
                </div>

                <div class="form-row">
                    <label>Strictness</label>
                    <div class="pill-group">
                        <label><input type="radio" name="strictness" value="NONE" checked /> Không ràng buộc</label>
                        <label><input type="radio" name="strictness" value="PREFER" /> Ưu tiên</label>
                        <label><input type="radio" name="strictness" value="STRICT" /> Chỉ</label>
                    </div>
                </div>

                <div class="form-row">
                    <label>Chọn thứ (nếu cần)</label>
                    <div class="weekday-pills" id="weekdayPills">
                        <label><input type="checkbox" value="MON" /> T2</label>
                        <label><input type="checkbox" value="TUE" /> T3</label>
                        <label><input type="checkbox" value="WED" /> T4</label>
                        <label><input type="checkbox" value="THU" /> T5</label>
                        <label><input type="checkbox" value="FRI" /> T6</label>
                        <label><input type="checkbox" value="SAT" /> T7</label>
                        <label><input type="checkbox" value="SUN" /> CN</label>
                    </div>
                </div>

                <div class="form-row">
                    <label>Chọn buổi (nếu cần)</label>
                    <div class="session-pills" id="sessionPills">
                        <label><input type="checkbox" value="DAWN" /> Sáng sớm (4:00–6:00)</label>
                        <label><input type="checkbox" value="MORNING" /> Sáng (6:00–11:00)</label>
                        <label><input type="checkbox" value="NOON" /> Trưa (11:00–13:00)</label>
                        <label><input type="checkbox" value="AFTERNOON" /> Chiều (13:00–17:00)</label>
                        <label><input type="checkbox" value="EVENING" /> Tối (17:00–23:00)</label>
                        <label><input type="checkbox" value="NIGHT" /> Đêm (23:00–4:00)</label>
                    </div>
                </div>

                <div class="form-row">
                    <label>
                        <input type="checkbox" id="taskPendingInput" />
                        Pending task (chỉ ghi nhớ, chưa tính trọng số)
                    </label>
                </div>

                <div class="form-row">
                    <label>
                        <input type="checkbox" id="taskParallelInput" />
                        Có thể làm song song (Parallel OK)
                    </label>
                </div>

                <div class="form-row">
                    <button id="addTaskBtn" onclick="addTask()">Thêm task</button>
                </div>
            </div>

            <div class="list-section">
                <h2>Danh sách công việc</h2>
                <div class="list-controls">
                    <label>
                        <input type="checkbox" id="hideDoneCheckbox" onchange="toggleHideDone()" />
                        Ẩn task đã DONE
                    </label>
                </div>
                <div id="taskList"></div>
            </div>
        </div>

        <!-- BACKGROUND TAB -->
        <div id="tab-background" class="hidden">
            <div class="card">
                <h2>Background tasks</h2>

                <div class="form-row">
                    <label>Ngày</label>
                    <input type="date" id="bgDateInput" />
                </div>

                <div class="form-row">
                    <label>Giờ bắt đầu</label>
                    <input type="time" id="bgStartInput" />
                </div>

                <div class="form-row">
                    <label>Giờ kết thúc</label>
                    <input type="time" id="bgEndInput" />
                </div>

                <div class="form-row">
                    <label>
                        <input type="checkbox" id="bgParallelInput" />
                        Cho phép parallel (slot vẫn Available)
                    </label>
                </div>

                <div class="form-row">
                    <button onclick="addBackgroundTask()">Thêm background task</button>
                </div>

                <div class="bg-list" id="backgroundList"></div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="tab-settings" class="hidden">
            <div class="card">
                <h2>Settings</h2>

                <div class="form-row">
                    <label>Quick task boost (phút ≤ 5):</label>
                    <input type="number" id="settingQuickBoost" min="0" max="1000" />
                </div>

                <div class="form-row">
                    <label>Time match multiplier (khi đúng buổi/ngày ưu tiên):</label>
                    <input type="number" id="settingTimeMatchMultiplier" min="0" max="10" step="0.1" />
                </div>

                <div class="form-row">
                    <label>Deadline penalty factor:</label>
                    <input type="number" id="settingDeadlinePenaltyFactor" min="0" max="10" step="0.1" />
                </div>

                <div class="form-row">
                    <label>Estimated weight (ảnh hưởng của t):</label>
                    <input type="number" id="settingEstimatedWeight" min="0" max="10" step="0.1" />
                </div>

                <div class="form-row">
                    <button onclick="saveSettings()">Lưu settings</button>
                    <button onclick="resetSettings()">Reset mặc định</button>
                </div>

                <div class="settings-note">
                    Settings được lưu localStorage (theo thiết bị).
                </div>
            </div>
        </div>

    </div><!-- /appContent -->
</div><!-- /container -->

<!-- POPUP EDIT TASK -->
<div id="editPopupOverlay" class="popup-overlay hidden">
    <div class="popup">
        <h3>Chỉnh sửa task</h3>

        <input type="hidden" id="editTaskId" />

        <div class="form-row">
            <label>Tên công việc</label>
            <input type="text" id="editTaskName" />
        </div>

        <div class="form-row">
            <label>Mô tả</label>
            <textarea id="editTaskDesc" rows="2"></textarea>
        </div>

        <div class="form-row">
            <label>Thời gian cần (phút)</label>
            <input type="number" id="editTaskEstimated" min="1" />
        </div>

        <div class="form-row">
            <label>Deadline</label>
            <input type="datetime-local" id="editTaskDeadline" />
        </div>

        <div class="form-row">
            <label>Strictness</label>
            <div class="pill-group" id="editStrictnessPills">
                <label><input type="radio" name="editStrict" value="NONE" /> Không ràng buộc</label>
                <label><input type="radio" name="editStrict" value="PREFER" /> Ưu tiên</label>
                <label><input type="radio" name="editStrict" value="STRICT" /> Chỉ</label>
            </div>
        </div>

        <div class="form-row">
            <label>Thứ ưu tiên / chỉ</label>
            <div class="weekday-pills" id="editWeekdayPills">
                <label><input type="checkbox" value="MON" /> T2</label>
                <label><input type="checkbox" value="TUE" /> T3</label>
                <label><input type="checkbox" value="WED" /> T4</label>
                <label><input type="checkbox" value="THU" /> T5</label>
                <label><input type="checkbox" value="FRI" /> T6</label>
                <label><input type="checkbox" value="SAT" /> T7</label>
                <label><input type="checkbox" value="SUN" /> CN</label>
            </div>
        </div>

        <div class="form-row">
            <label>Buổi ưu tiên / chỉ</label>
            <div class="session-pills" id="editSessionPills">
                <label><input type="checkbox" value="DAWN" /> Sáng sớm</label>
                <label><input type="checkbox" value="MORNING" /> Sáng</label>
                <label><input type="checkbox" value="NOON" /> Trưa</label>
                <label><input type="checkbox" value="AFTERNOON" /> Chiều</label>
                <label><input type="checkbox" value="EVENING" /> Tối</label>
                <label><input type="checkbox" value="NIGHT" /> Đêm</label>
            </div>
        </div>

        <div class="form-row">
            <div class="pill-group">
                <label style="font-size:13px;">
                    <input type="checkbox" id="editPending" />
                    Pending task
                </label>
            </div>
        </div>

        <div class="form-row">
            <div class="pill-group">
                <label style="font-size:13px;">
                    <input type="checkbox" id="editCanParallel" />
                    Có thể làm song song (Parallel OK)
                </label>
            </div>
        </div>

        <button onclick="saveEdit()">Lưu</button>
        <button class="close-btn" onclick="closePopup()">Đóng</button>
    </div>
</div>

<script type="module" src="app.js"></script>
</body>
</html>
