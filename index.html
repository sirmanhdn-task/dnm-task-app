<!--
VERSION: V6.2
DATE: 2025-01-15
CHANGES:
- Thêm buildSlots() với độ phân giải 10 phút, giới hạn timeline 14 ngày
- Shading Available/Unavailable dựa trên slots (ưu tiên non-parallel background)
- Giữ nguyên giao diện: Timeline + List + Background + Settings, zoom, JumpToNow
- Thêm nhãn ngày trên timeline (Day labels) trong header
-->

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>DNM Task Scheduler V6.2</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<div class="container">

    <h1>DNM Task Scheduler</h1>

    <!-- Auth -->
    <div id="authBar" class="auth-bar">
        <div id="userInfo" class="user-info hidden">
            <span id="userName"></span>
            <button id="logoutBtn" class="logout-btn">Đăng xuất</button>
        </div>
        <div id="loginArea">
            <button id="loginBtn" class="login-btn">Đăng nhập Google</button>
        </div>
    </div>

    <div id="notLoggedInMessage">
        <p>Đăng nhập để sử dụng và đồng bộ dữ liệu.</p>
    </div>

    <div id="appContent" class="hidden">

        <!-- TAB NAV -->
        <div class="tab-nav">
            <button id="tab-btn-timeline" class="tab-btn tab-active" onclick="switchTab('timeline')">Timeline</button>
            <button id="tab-btn-background" class="tab-btn" onclick="switchTab('background')">Background</button>
            <button id="tab-btn-settings" class="tab-btn" onclick="switchTab('settings')">Settings</button>
        </div>

        <!-- TAB: TIMELINE (bao gồm Timeline + List) -->
        <div id="tab-timeline">
            <!-- CARD: TIMELINE -->
            <div class="card">
                <h2>Timeline</h2>

                <div class="timeline-topbar">
                    <button id="jumpNowBtn" class="jump-now-btn" onclick="jumpToNow()">Hiện tại</button>
                    <button id="debugSlotsBtn" class="jump-now-btn" style="background:#555;" onclick="debugSlots()">Debug Slots</button>
                    <div class="zoom-controls">
                        <button onclick="zoomOut()">−</button>
                        <span id="zoomDisplay">100%</span>
                        <button onclick="zoomIn()">+</button>
                    </div>
                </div>

                <div class="timeline-scroll">
                    <div id="timelineContainer" class="timeline-container">
                        <div id="timelineDays" class="timeline-days"></div>

                        <!-- Lớp shading availability -->
                        <div id="timelineAvailability" class="timeline-availability"></div>

                        <div class="timeline-header" id="timelineHeader"></div>

                        <div class="timeline-lane timeline-lane-normal" id="lane-normal"></div>
                        <div class="timeline-lane timeline-lane-background" id="lane-background"></div>
                        <div class="timeline-lane timeline-lane-pending" id="lane-pending"></div>

                        <div id="timelineCurrentLine" class="timeline-current-line"></div>
                    </div>
                </div>

                <div class="timeline-legend">
                    <span class="legend-box legend-normal"></span> Normal
                    <span class="legend-box legend-background"></span> Background
                    <span class="legend-box legend-pending"></span> Pending
                </div>
                <div class="timeline-legend">
                    <span style="display:inline-block;width:20px;height:10px;background:rgba(0,200,0,0.05);border:1px solid #a5d6a7;"></span>
                    Available
                    <span style="display:inline-block;width:20px;height:10px;background:rgba(255,0,0,0.08);border:1px solid #ef9a9a;margin-left:10px;"></span>
                    Unavailable (non-parallel BG)
                </div>
            </div>

            <!-- FORM + LIST dưới Timeline -->
            <div class="form-section">
                <h2>Thêm công việc</h2>

                <input id="name" type="text" placeholder="Tên công việc" />
                <textarea id="description" placeholder="Mô tả"></textarea>

                <label>Thời gian cần (phút):</label>
                <input id="estimated" type="number" min="1" value="10"/>

                <label>Deadline:</label>
                <input id="deadline" type="datetime-local" />

                <div class="pill-group">
                    <div class="pill-group-title">Loại task</div>
                    <div class="pill-row">
                        <label class="mode-label">
                            <input type="radio" name="typeAdd" value="normal" checked />
                            Normal
                        </label>
                        <label class="mode-label">
                            <input type="radio" name="typeAdd" value="pending" />
                            Pending
                        </label>
                    </div>
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">Chế độ thời gian</div>
                    <div class="pill-row">
                        <label class="mode-label">
                            <input type="radio" name="modeAdd" value="STRICT" />
                            CHỈ
                        </label>
                        <label class="mode-label">
                            <input type="radio" name="modeAdd" value="PREFER" checked />
                            ƯU TIÊN
                        </label>
                    </div>
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">Thứ (bỏ trống = bất kỳ)</div>
                    <div class="pill-row">
                        <button type="button" class="pill weekday-pill-add" data-value="MON" onclick="togglePill(this)">T2</button>
                        <button type="button" class="pill weekday-pill-add" data-value="TUE" onclick="togglePill(this)">T3</button>
                        <button type="button" class="pill weekday-pill-add" data-value="WED" onclick="togglePill(this)">T4</button>
                        <button type="button" class="pill weekday-pill-add" data-value="THU" onclick="togglePill(this)">T5</button>
                        <button type="button" class="pill weekday-pill-add" data-value="FRI" onclick="togglePill(this)">T6</button>
                        <button type="button" class="pill weekday-pill-add" data-value="SAT" onclick="togglePill(this)">T7</button>
                        <button type="button" class="pill weekday-pill-add" data-value="SUN" onclick="togglePill(this)">CN</button>
                    </div>
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">Buổi (bỏ trống = bất kỳ)</div>
                    <div class="pill-row">
                        <button type="button" class="pill session-pill-add" data-value="DAWN" onclick="togglePill(this)">Sáng sớm</button>
                        <button type="button" class="pill session-pill-add" data-value="MORNING" onclick="togglePill(this)">Sáng</button>
                        <button type="button" class="pill session-pill-add" data-value="NOON" onclick="togglePill(this)">Trưa</button>
                        <button type="button" class="pill session-pill-add" data-value="AFTERNOON" onclick="togglePill(this)">Chiều</button>
                        <button type="button" class="pill session-pill-add" data-value="EVENING" onclick="togglePill(this)">Tối</button>
                        <button type="button" class="pill session-pill-add" data-value="NIGHT" onclick="togglePill(this)">Đêm</button>
                    </div>
                </div>

                <div class="pill-group">
                    <label style="font-size:13px;">
                        <input type="checkbox" id="addCanParallel" />
                        Có thể làm song song (Parallel OK)
                    </label>
                </div>

                <button onclick="addTask()">Thêm</button>
            </div>

            <h2>Danh sách công việc</h2>
            <div id="taskList"></div>
        </div>

        <!-- TAB: BACKGROUND -->
        <div id="tab-background" class="hidden">
            <h2>Background tasks</h2>

            <div class="card">
                <h3>Tạo background task</h3>
                <div class="form-row">
                    <label>Tên:</label>
                    <input type="text" id="bgName" placeholder="VD: Ngủ, Làm ở công ty" />
                </div>
                <div class="form-row">
                    <label>Mô tả:</label>
                    <textarea id="bgDescription" rows="2" placeholder="Ghi chú thêm (tuỳ chọn)"></textarea>
                </div>
                <div class="form-row">
                    <label>Ngày:</label>
                    <input type="date" id="bgDate" />
                </div>
                <div class="form-row">
                    <label>Bắt đầu:</label>
                    <input type="time" id="bgStartTime" />
                </div>
                <div class="form-row">
                    <label>Kết thúc:</label>
                    <input type="time" id="bgEndTime" />
                </div>
                <div class="form-row">
                    <label>
                        <input type="checkbox" id="bgParallel" />
                        Cho phép làm task thường song song (parallel)
                    </label>
                </div>
                <button onclick="addBackgroundTask()">Thêm background task</button>
            </div>

            <div class="card">
                <h3>Danh sách background tasks</h3>
                <div id="bgTaskList"></div>
            </div>
        </div>

        <!-- TAB: SETTINGS -->
        <div id="tab-settings" class="hidden">
            <div class="card">
                <h2>Settings – Chấm điểm</h2>

                <div class="pill-group">
                    <div class="pill-group-title">QuickBoost (task ≤ 5 phút)</div>
                    <input id="settingQuickBoost"
                           type="number"
                           step="1"
                           onchange="updateNumericSetting('quickBoost', this.value)" />
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">TimeMatchMultiplier</div>
                    <input id="settingTimeMatchMultiplier"
                           type="number"
                           step="0.1"
                           onchange="updateNumericSetting('timeMatchMultiplier', this.value)" />
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">DeadlinePenaltyFactor</div>
                    <input id="settingDeadlinePenalty"
                           type="number"
                           step="0.1"
                           onchange="updateNumericSetting('deadlinePenaltyFactor', this.value)" />
                </div>

                <div class="pill-group">
                    <div class="pill-group-title">EstimatedTimeWeight</div>
                    <input id="settingEstimatedWeight"
                           type="number"
                           step="0.1"
                           onchange="updateNumericSetting('estimatedWeight', this.value)" />
                </div>

                <div class="pill-group">
                    <label style="font-size:13px;">
                        <input id="settingHideDone"
                               type="checkbox"
                               onchange="updateBoolSetting('hideDone', this.checked)" />
                        Ẩn task đã Done khỏi List
                    </label>
                </div>

                <div id="settingsNowInfo" style="font-size:13px;margin-top:8px;color:#555;"></div>
            </div>
        </div>

    </div>
</div>

<!-- Popup edit -->
<div id="editPopup" class="popup hidden">
    <div class="popup-content">
        <h2>Sửa Task</h2>

        <input id="editName" type="text"/>
        <textarea id="editDescription"></textarea>
        <label>Thời gian (phút):</label>
        <input id="editEstimated" type="number" min="1"/>
        <label>Deadline:</label>
        <input id="editDeadline" type="datetime-local"/>

        <div class="pill-group">
            <div class="pill-group-title">Loại task</div>
            <div class="pill-row">
                <label class="mode-label">
                    <input type="radio" name="typeEdit" value="normal" />
                    Normal
                </label>
                <label class="mode-label">
                    <input type="radio" name="typeEdit" value="pending" />
                    Pending
                </label>
            </div>
        </div>

        <div class="pill-group">
            <div class="pill-group-title">Chế độ thời gian</div>
            <div class="pill-row">
                <label class="mode-label">
                    <input type="radio" name="modeEdit" value="STRICT" />
                    CHỈ
                </label>
                <label class="mode-label">
                    <input type="radio" name="modeEdit" value="PREFER" />
                    ƯU TIÊN
                </label>
            </div>
        </div>

        <div class="pill-group">
            <div class="pill-group-title">Thứ</div>
            <div class="pill-row">
                <button type="button" class="pill weekday-pill-edit" data-value="MON" onclick="togglePill(this)">T2</button>
                <button type="button" class="pill weekday-pill-edit" data-value="TUE" onclick="togglePill(this)">T3</button>
                <button type="button" class="pill weekday-pill-edit" data-value="WED" onclick="togglePill(this)">T4</button>
                <button type="button" class="pill weekday-pill-edit" data-value="THU" onclick="togglePill(this)">T5</button>
                <button type="button" class="pill weekday-pill-edit" data-value="FRI" onclick="togglePill(this)">T6</button>
                <button type="button" class="pill weekday-pill-edit" data-value="SAT" onclick="togglePill(this)">T7</button>
                <button type="button" class="pill weekday-pill-edit" data-value="SUN" onclick="togglePill(this)">CN</button>
            </div>
        </div>

        <div class="pill-group">
            <div class="pill-group-title">Buổi</div>
            <div class="pill-row">
                <button type="button" class="pill session-pill-edit" data-value="DAWN" onclick="togglePill(this)">Sáng sớm</button>
                <button type="button" class="pill session-pill-edit" data-value="MORNING" onclick="togglePill(this)">Sáng</button>
                <button type="button" class="pill session-pill-edit" data-value="NOON" onclick="togglePill(this)">Trưa</button>
                <button type="button" class="pill session-pill-edit" data-value="AFTERNOON" onclick="togglePill(this)">Chiều</button>
                <button type="button" class="pill session-pill-edit" data-value="EVENING" onclick="togglePill(this)">Tối</button>
                <button type="button" class="pill session-pill-edit" data-value="NIGHT" onclick="togglePill(this)">Đêm</button>
            </div>
        </div>

        <div class="pill-group">
            <label style="font-size:13px;">
                <input type="checkbox" id="editCanParallel" />
                Có thể làm song song (Parallel OK)
            </label>
        </div>

        <button onclick="saveEdit()">Lưu</button>
        <button class="close-btn" onclick="closePopup()">Đóng</button>
    </div>
</div>

<script type="module" src="app.js"></script>
</body>
</html>
